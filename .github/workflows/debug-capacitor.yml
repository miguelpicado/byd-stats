name: Debug Capacitor Sync

on:
  workflow_dispatch:

jobs:
  debug:
    name: Debug Capacitor
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: List all files in repo
        run: |
          echo "ðŸ“‚ All files in repository:"
          find . -type f | grep -v ".git/" | head -50

      - name: Check critical files
        run: |
          echo "ðŸ” Checking critical files exist..."
          files=(
            "capacitor.config.json"
            "package.json"
            "package-lock.json"
            "android/build.gradle"
            "android/settings.gradle"
            "android/app/build.gradle"
            "android/gradlew"
          )
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file MISSING!"
            fi
          done

      - name: Show capacitor.config.json
        run: |
          echo "ðŸ“ Content of capacitor.config.json:"
          cat capacitor.config.json

      - name: Show package.json
        run: |
          echo "ðŸ“¦ Capacitor deps in package.json:"
          cat package.json | grep -A 10 '"dependencies"'

      - name: Install dependencies
        run: |
          echo "ðŸ“¥ Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed"

      - name: Check Capacitor CLI
        run: |
          echo "ðŸ”§ Capacitor CLI version:"
          npx cap --version
          echo ""
          echo "ðŸ“‹ Capacitor doctor:"
          npx cap doctor

      - name: Build web app
        run: |
          echo "ðŸ—ï¸ Building web app..."
          npm run build
          echo "âœ… Build completed"

      - name: Show dist folder
        run: |
          echo "ðŸ“‚ Content of dist folder:"
          ls -laR dist/
          echo ""
          echo "Total files in dist:"
          find dist -type f | wc -l

      - name: Show Android folder BEFORE sync
        run: |
          echo "ðŸ“‚ Android folder BEFORE sync:"
          ls -la android/
          echo ""
          echo "ðŸ“‚ Android app folder:"
          ls -la android/app/ 2>&1 || echo "No app folder"
          echo ""
          echo "ðŸ“‚ Android assets folder:"
          ls -la android/app/src/main/assets/ 2>&1 || echo "No assets folder"

      - name: Try Capacitor sync with FULL output
        run: |
          echo "ðŸ”„ Attempting Capacitor sync with verbose logging..."
          npx cap sync android --verbose 2>&1 | tee capacitor-sync.log
          echo ""
          echo "ðŸ“„ Full sync log above â˜ï¸"

      - name: Show Android folder AFTER sync
        run: |
          echo "ðŸ“‚ Android folder AFTER sync:"
          ls -la android/
          echo ""
          echo "ðŸ“‚ Android app folder:"
          ls -la android/app/ 2>&1 || echo "No app folder"
          echo ""
          echo "ðŸ“‚ Android assets folder:"
          ls -la android/app/src/main/assets/ 2>&1 || echo "No assets folder"
          echo ""
          echo "ðŸ“‚ Public folder in assets:"
          ls -la android/app/src/main/assets/public/ 2>&1 || echo "No public folder"
          echo ""
          echo "Files in public:"
          find android/app/src/main/assets/public/ -type f 2>&1 | head -20 || echo "No files"

      - name: Upload sync log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: capacitor-sync-debug-log
          path: capacitor-sync.log
          retention-days: 7
