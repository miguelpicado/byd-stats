name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.0.1-alpha)'
        required: true
        type: string
      release_name:
        description: 'Release name (optional, defaults to version)'
        required: false
        type: string
      prerelease:
        description: 'Mark as pre-release?'
        required: false
        type: boolean
        default: true

jobs:
  build-and-release:
    name: Build APK and Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Install dependencies
        run: npm ci

      - name: Build web app
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Install Android SDK Platform 36
        run: |
          echo "ðŸ“¦ Installing Android SDK Platform 36..."
          ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-36"
          echo "âœ… Android SDK 36 installed"

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Build Debug APK
        run: |
          cd android
          ./gradlew assembleDebug --stacktrace

      - name: Build Release APK
        run: |
          cd android
          ./gradlew assembleRelease --stacktrace
        continue-on-error: true

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: ${{ github.event.inputs.release_name || github.event.inputs.version }}
          body: |
            ## ðŸ“± BYD Stats Android App

            **Version:** ${{ github.event.inputs.version }}
            **Build Date:** ${{ steps.date.outputs.date }}

            ### âœ¨ Features
            - Responsive design optimized for mobile and tablet
            - Full BYD Stats functionality
            - Local SQLite database processing
            - Interactive Recharts data visualization
            - Dark theme optimized for mobile devices

            ### ðŸ“¥ Installation
            1. Download `app-debug.apk` below
            2. Enable "Install from unknown sources" in your Android settings
            3. Open the APK file and install
            4. Enjoy BYD Stats on your Android device!

            ### âš ï¸ Note
            This is a debug build for testing purposes. You may need to enable installation from unknown sources in your Android settings.

            ---

            ðŸ”§ Built with Capacitor 8 â€¢ React 19 â€¢ Vite 7 â€¢ Tailwind CSS
          files: |
            android/app/build/outputs/apk/debug/app-debug.apk
            android/app/build/outputs/apk/release/app-release-unsigned.apk
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "### ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Name:** ${{ github.event.inputs.release_name || github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release:** ${{ github.event.inputs.prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“± Your release is now available in the **Releases** section!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.version }})" >> $GITHUB_STEP_SUMMARY
