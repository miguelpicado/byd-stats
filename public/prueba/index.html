<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug v3 - BYD Stats</title>
    <link rel="manifest" href="/prueba/manifest.json">
    <meta name="theme-color" content="#ea0029">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        body {
            font-family: system-ui, sans-serif;
            background: #0f172a;
            color: #fff;
            padding: 8px;
            font-size: 12px
        }

        h1 {
            color: #ea0029;
            text-align: center;
            font-size: 1rem;
            margin: 8px 0
        }

        h2 {
            font-size: 0.85rem;
            color: #94a3b8;
            margin: 4px 0
        }

        .c {
            background: #1e293b;
            border-radius: 8px;
            padding: 10px;
            margin: 6px 0;
            border: 1px solid #334155
        }

        .important {
            border-color: #ea0029;
            background: #1e1e2e
        }

        .btn {
            width: 100%;
            padding: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 4px 0;
            color: #fff
        }

        .r {
            background: #ea0029
        }

        .g {
            background: #059669
        }

        .y {
            background: #d97706
        }

        .b {
            background: #0284c7
        }

        .gr {
            background: #475569
        }

        .sm {
            padding: 8px 12px;
            width: auto;
            font-size: 0.75rem
        }

        input[type=file] {
            display: none
        }

        input[type=text] {
            width: 100%;
            padding: 10px;
            background: #0f172a;
            border: 1px solid #475569;
            color: #fff;
            border-radius: 4px;
            margin: 4px 0;
            font-size: 12px
        }

        .log {
            background: #0f172a;
            border-radius: 4px;
            padding: 8px;
            font-family: monospace;
            font-size: 10px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all
        }

        .log-i {
            color: #60a5fa
        }

        .log-s {
            color: #4ade80
        }

        .log-e {
            color: #f87171
        }

        .log-w {
            color: #fbbf24
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px
        }

        .result {
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            font-size: 1rem;
            text-align: center
        }

        .result.ok {
            border-color: #4ade80
        }

        .result.no {
            border-color: #f87171
        }

        .info {
            font-size: 0.75rem;
            color: #94a3b8;
            margin: 4px 0;
            line-height: 1.4
        }

        .step {
            background: #334155;
            padding: 6px 10px;
            border-radius: 4px;
            margin: 3px 0;
            font-size: 0.75rem
        }

        .flex {
            display: flex;
            gap: 4px;
            flex-wrap: wrap
        }

        .tag {
            background: #334155;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            margin: 1px
        }

        .tag.ok {
            background: #059669
        }

        .tag.no {
            background: #dc2626
        }

        code {
            background: #334155;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem
        }
    </style>
</head>

<body>
    <h1>üî¨ Debug v3 - BYD Stats</h1>
    <p style="text-align:center;color:#64748b;font-size:0.7rem">Ruta: /Local/energydata/EC_Database.db</p>

    <!-- RESULTADO -->
    <div id="mainResult" class="result" style="display:none"></div>

    <!-- PASO 0: Chrome Flags -->
    <div class="c important">
        <h2>‚öôÔ∏è PASO 0: Chrome Flags (hacer primero)</h2>
        <p class="info">Antes de probar los m√©todos, intenta activar estas flags:</p>
        <div class="step">1. Abre nueva pesta√±a ‚Üí escribe <code>chrome://flags</code></div>
        <div class="step">2. Busca <code>picker</code> o <code>media</code></div>
        <div class="step">3. Si existe <code>#media-picker-adoption</code> ‚Üí <b>Disabled</b></div>
        <div class="step">4. Si existe <code>#deprecated-external-picker</code> ‚Üí <b>Enabled</b></div>
        <div class="step">5. Busca <code>file</code> y prueba cualquier flag relacionada</div>
        <div class="step">6. Pulsa <b>Relaunch</b> para reiniciar Chrome</div>
        <button class="btn b" onclick="window.open('chrome://flags','_blank')">üöÄ Abrir chrome://flags</button>
    </div>

    <!-- M√âTODO 1: Input File TRUCO -->
    <div class="c important">
        <h2>üéØ M√âTODO 1: Selector de Archivos (TRUCO)</h2>
        <p class="info">Estos botones usan diferentes combinaciones de MIME types para intentar abrir un selector de
            archivos completo en lugar de solo galer√≠a.</p>
        <div class="grid">
            <button class="btn g" onclick="$('f0').click()">üéØ TRUCO 1</button>
            <button class="btn g" onclick="$('f1').click()">üéØ TRUCO 2</button>
            <button class="btn y" onclick="$('f2').click()">img+text</button>
            <button class="btn y" onclick="$('f3').click()">all mixed</button>
            <button class="btn gr" onclick="$('f4').click()">*/*</button>
            <button class="btn gr" onclick="$('f5').click()">sin accept</button>
        </div>
        <!-- Trucos principales -->
        <input type="file" id="f0" accept="image/*,text/plain,application/octet-stream"
            onchange="onFile(this,'üéØ TRUCO 1')">
        <input type="file" id="f1" accept="text/*,image/*,video/*,.db,.sqlite" onchange="onFile(this,'üéØ TRUCO 2')">
        <input type="file" id="f2" accept="image/*,text/*" onchange="onFile(this,'img+text')">
        <input type="file" id="f3" accept="image/*,text/plain,video/*,audio/*,.db,.sqlite,application/octet-stream,*/*"
            onchange="onFile(this,'all mixed')">
        <input type="file" id="f4" accept="*/*" onchange="onFile(this,'*/*')">
        <input type="file" id="f5" onchange="onFile(this,'sin accept')">
    </div>

    <!-- M√âTODO 2: Directorio -->
    <div class="c">
        <h2>üìÇ M√âTODO 2: Seleccionar Carpeta</h2>
        <p class="info">Intenta seleccionar la carpeta energydata completa</p>
        <button class="btn y" onclick="$('fdir').click()">üìÇ Seleccionar carpeta (webkitdirectory)</button>
        <input type="file" id="fdir" webkitdirectory onchange="onDir(this)">
    </div>

    <!-- M√âTODO 3: Red Local -->
    <div class="c">
        <h2>üì° M√âTODO 3: Red Local (HTTP)</h2>
        <p class="info">Si tienes el archivo en un servidor HTTP en la misma WiFi (ej: m√≥vil con servidor web)</p>
        <input type="text" id="netUrl" placeholder="http://192.168.X.X:8080/EC_Database.db">
        <button class="btn g" onclick="fetchNet()">üì° Descargar de red</button>
    </div>

    <!-- M√âTODO 4: WebSocket -->
    <div class="c">
        <h2>üîå M√âTODO 4: WebSocket Local</h2>
        <p class="info">Conectar a un servidor WebSocket en la red local</p>
        <input type="text" id="wsUrl" placeholder="ws://192.168.X.X:8080">
        <button class="btn b" onclick="tryWebSocket()">üîå Conectar WebSocket</button>
    </div>

    <!-- M√âTODO 5: Navegaci√≥n directa -->
    <div class="c">
        <h2>üß≠ M√âTODO 5: Navegaci√≥n a file://</h2>
        <p class="info">Navega directamente a la ruta del archivo (saldr√°s de esta p√°gina)</p>
        <button class="btn y" onclick="tryNavigate()">üß≠ Navegar a file:///Local/energydata/</button>
    </div>

    <!-- APIs disponibles -->
    <div class="c">
        <h2>üìä APIs Detectadas</h2>
        <div id="apis" class="flex"></div>
    </div>

    <!-- Export -->
    <div class="c">
        <h2>üì§ Exportar Log</h2>
        <div class="flex">
            <button class="btn sm r" onclick="toGH()">üêô GitHub</button>
            <button class="btn sm g" onclick="share()">üì§ Share</button>
            <button class="btn sm y" onclick="copy()">üìã Copy</button>
        </div>
    </div>

    <!-- Log -->
    <div class="c">
        <h2>üìã Log</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        const logs = [];

        function log(m, t = 'i') {
            const ts = new Date().toLocaleTimeString();
            logs.push({ ts, t, m });
            $('log').innerHTML += `<span class="log-${t}">[${ts}][${t}] ${m}</span>\n`;
            $('log').scrollTop = $('log').scrollHeight;
        }

        function showResult(msg, ok) {
            const r = $('mainResult');
            r.style.display = 'block';
            r.textContent = msg;
            r.className = 'result ' + (ok ? 'ok' : 'no');
        }

        // Procesar archivo
        function processBlob(blob, name) {
            log(`Procesando: ${name}, ${blob.size} bytes`, 's');

            if (blob.size < 1000) {
                log('Archivo muy peque√±o, probablemente no es el correcto', 'w');
            }

            // Verificar si es SQLite
            const reader = new FileReader();
            reader.onload = e => {
                const arr = new Uint8Array(e.target.result);
                const header = String.fromCharCode.apply(null, arr.slice(0, 6));
                if (header === 'SQLite') {
                    log('‚úÖ ¬°Es un archivo SQLite v√°lido!', 's');
                    showResult('‚úÖ ¬°√âXITO! SQLite detectado: ' + name + ' (' + blob.size + ' bytes)', true);
                } else {
                    log('Header: ' + header, 'w');
                    showResult('Archivo recibido: ' + name + ' (' + blob.size + ' bytes)', true);
                }
            };
            reader.readAsArrayBuffer(blob.slice(0, 16));
        }

        // 1. Input File
        function onFile(input, method) {
            const f = input.files[0];
            if (!f) { log('No se seleccion√≥ archivo con ' + method, 'w'); return }
            log(`[${method}] Archivo: ${f.name}, Tipo: ${f.type}, Tama√±o: ${f.size}`, 's');
            processBlob(f, f.name);
        }

        // 2. Directory
        function onDir(input) {
            const files = input.files;
            log(`Carpeta: ${files.length} archivos`, 'i');
            for (const f of files) {
                log(`  - ${f.webkitRelativePath}: ${f.size}b`, 'i');
                if (f.name.toLowerCase().includes('database') || f.name.endsWith('.db')) {
                    log('¬°Encontrado posible DB!', 's');
                    processBlob(f, f.name);
                }
            }
        }

        // 3. Network Fetch
        async function fetchNet() {
            const url = $('netUrl').value;
            if (!url) { log('Ingresa URL de red', 'w'); return }
            log('Descargando: ' + url, 'i');
            try {
                const r = await fetch(url);
                if (!r.ok) throw new Error('HTTP ' + r.status);
                const b = await r.blob();
                log('Descargado: ' + b.size + ' bytes', 's');
                processBlob(b, 'network.db');
                showResult('‚úÖ Red funcion√≥: ' + b.size + ' bytes', true);
            } catch (e) {
                log('Error red: ' + e.message, 'e');
                showResult('‚ùå Red: ' + e.message, false);
            }
        }

        // 4. WebSocket
        function tryWebSocket() {
            const url = $('wsUrl').value;
            if (!url) { log('Ingresa URL WebSocket', 'w'); return }
            log('Conectando WS: ' + url, 'i');
            try {
                const ws = new WebSocket(url);
                ws.onopen = () => log('WS conectado', 's');
                ws.onmessage = e => {
                    log('WS mensaje: ' + (typeof e.data === 'string' ? e.data.substring(0, 100) : e.data.size + 'b'), 's');
                    if (e.data instanceof Blob) processBlob(e.data, 'ws.db');
                };
                ws.onerror = () => log('WS error', 'e');
                ws.onclose = () => log('WS cerrado', 'i');
            } catch (e) { log('WS exception: ' + e.message, 'e') }
        }

        // 5. Navigate
        function tryNavigate() {
            if (!confirm('Saldr√°s de esta p√°gina. ¬øContinuar?')) return;
            const url = 'file:///Local/energydata/';
            log('Navegando a: ' + url, 'i');
            window.location.href = url;
        }

        // Detectar APIs
        function detectAPIs() {
            const apis = {
                'showDirectoryPicker': 'showDirectoryPicker' in window,
                'showOpenFilePicker': 'showOpenFilePicker' in window,
                'webkitdirectory': 'webkitdirectory' in document.createElement('input'),
                'FileReader': 'FileReader' in window,
                'Blob': 'Blob' in window,
                'IndexedDB': 'indexedDB' in window,
                'localStorage': 'localStorage' in window,
                'Clipboard': 'clipboard' in navigator,
                'Share': 'share' in navigator,
                'BroadcastChannel': 'BroadcastChannel' in window,
                'WebSocket': 'WebSocket' in window,
                'ServiceWorker': 'serviceWorker' in navigator
            };
            $('apis').innerHTML = Object.entries(apis).map(([n, ok]) => {
                log(`API ${n}: ${ok ? 'S√ç' : 'NO'}`, ok ? 's' : 'w');
                return `<span class="tag ${ok ? 'ok' : 'no'}">${ok ? '‚úÖ' : '‚ùå'} ${n}</span>`;
            }).join('');
        }

        // Export
        function getLog() { return logs.map(l => `[${l.ts}][${l.t}] ${l.m}`).join('\n') }
        function toGH() {
            const b = encodeURIComponent('```\n' + getLog() + '\n```');
            const t = encodeURIComponent('[Debug v3] ' + new Date().toISOString());
            window.open(`https://github.com/miguelpicado/byd-stats/issues/new?title=${t}&body=${b}&labels=debug`, '_blank');
        }
        function share() { navigator.share?.({ title: 'Debug', text: getLog() }) || log('Share no disponible', 'e') }
        function copy() { navigator.clipboard.writeText(getLog()).then(() => log('Copiado', 's')).catch(e => log(e.message, 'e')) }

        // Register SW
        async function registerSW() {
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('/prueba/sw.js', { scope: '/prueba/' });
                    log('Service Worker registrado', 's');
                } catch (e) { log('SW error: ' + e.message, 'e') }
            }
        }

        // Init
        log('Debug v3 iniciado', 'i');
        log('UA: ' + navigator.userAgent, 'i');
        log('Ruta objetivo: /Local/energydata/EC_Database.db', 'i');
        detectAPIs();
        registerSW();
    </script>
</body>

</html>