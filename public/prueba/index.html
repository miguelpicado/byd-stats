<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - BYD Stats</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: #0f172a;
            color: white;
            min-height: 100vh;
            padding: 10px;
            font-size: 13px;
        }

        h1 {
            color: #ea0029;
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-bottom: 6px;
        }

        .card {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 10px;
            padding: 10px;
            margin: 6px 0;
            border: 1px solid #334155;
        }

        .btn {
            width: 100%;
            padding: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 4px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: #ea0029;
            color: white;
        }

        .btn-secondary {
            background: #334155;
            color: white;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-warning {
            background: #d97706;
            color: white;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 0.75rem;
            width: auto;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 4px;
        }

        .stat {
            background: #1e293b;
            padding: 6px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: bold;
            color: #4ade80;
        }

        .stat-label {
            font-size: 0.65rem;
            color: #64748b;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            margin: 2px;
        }

        .badge-yes {
            background: #059669;
        }

        .badge-no {
            background: #dc2626;
        }

        input[type="file"] {
            display: none;
        }

        /* GIANT SUMMARY - Easy to photograph */
        .giant-summary {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 3px solid #ea0029;
            border-radius: 16px;
            padding: 16px;
            margin: 10px 0;
            text-align: center;
        }

        .giant-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .giant-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 12px 0;
        }

        .giant-item {
            background: #0f172a;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #334155;
        }

        .giant-label {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 4px;
        }

        .giant-value {
            font-size: 1.6rem;
            font-weight: bold;
        }

        .giant-yes {
            color: #4ade80;
        }

        .giant-no {
            color: #f87171;
        }

        .giant-info {
            color: #60a5fa;
        }

        .giant-ua {
            font-size: 0.7rem;
            color: #64748b;
            word-break: break-all;
            text-align: left;
            background: #0f172a;
            padding: 8px;
            border-radius: 6px;
            margin-top: 10px;
        }

        /* Log styles */
        .log-container {
            background: #0f172a;
            border-radius: 6px;
            padding: 8px;
            font-family: monospace;
            font-size: 10px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-entry {
            margin: 1px 0;
            padding: 1px 0;
            border-bottom: 1px solid #1e293b;
        }

        .log-info {
            color: #60a5fa;
        }

        .log-success {
            color: #4ade80;
        }

        .log-error {
            color: #f87171;
        }

        .log-warning {
            color: #fbbf24;
        }

        .log-debug {
            color: #a78bfa;
        }

        .log-time {
            color: #64748b;
        }

        /* Textarea for manual copy */
        .copy-area {
            width: 100%;
            height: 100px;
            background: #0f172a;
            color: #94a3b8;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 8px;
            font-family: monospace;
            font-size: 9px;
            resize: none;
        }

        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .button-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
    </style>
</head>

<body>
    <h1>üî¨ Debug BYD Stats</h1>

    <!-- GIANT PHOTO-FRIENDLY SUMMARY -->
    <div class="giant-summary" id="giantSummary">
        <div class="giant-title">üìä RESUMEN R√ÅPIDO</div>
        <div class="giant-grid">
            <div class="giant-item">
                <div class="giant-label">Navegador</div>
                <div class="giant-value giant-info" id="gBrowser">-</div>
            </div>
            <div class="giant-item">
                <div class="giant-label">Sistema</div>
                <div class="giant-value giant-info" id="gOS">-</div>
            </div>
            <div class="giant-item">
                <div class="giant-label">showDirectoryPicker</div>
                <div class="giant-value" id="gDirPicker">-</div>
            </div>
            <div class="giant-item">
                <div class="giant-label">webkitdirectory</div>
                <div class="giant-value" id="gWebkit">-</div>
            </div>
        </div>
        <div class="giant-ua" id="gUA">User Agent: cargando...</div>
    </div>

    <!-- Test Buttons -->
    <div class="card">
        <h2>üß™ Pruebas</h2>
        <button class="btn btn-primary" onclick="testShowDirectoryPicker()">üöÄ showDirectoryPicker</button>
        <button class="btn btn-secondary" onclick="testWebkitDirectory()">üìÅ webkitdirectory</button>
        <input type="file" id="folderInput" webkitdirectory multiple />
        <button class="btn btn-secondary" onclick="testFileInput()">üìÑ Selector archivos</button>
        <input type="file" id="fileInput" accept="*/*" />
    </div>

    <!-- Test Results - Giant display -->
    <div class="giant-summary" id="testResults" style="display:none; border-color: #4ade80;">
        <div class="giant-title" id="resultTitle">üìÅ RESULTADO</div>
        <div class="giant-grid">
            <div class="giant-item">
                <div class="giant-label">Archivos</div>
                <div class="giant-value giant-info" id="rFiles">0</div>
            </div>
            <div class="giant-item">
                <div class="giant-label">Archivos .db</div>
                <div class="giant-value" id="rDB">0</div>
            </div>
        </div>
        <div class="giant-item" style="margin-top: 10px;">
            <div class="giant-label">EC_Database.db</div>
            <div class="giant-value" id="rEC" style="font-size: 2rem;">-</div>
        </div>
        <div id="rFileList"
            style="text-align: left; font-size: 0.8rem; margin-top: 10px; max-height: 150px; overflow-y: auto;"></div>
    </div>

    <!-- Export Options -->
    <div class="card">
        <div class="section-title">
            <h2>üì§ Exportar Log</h2>
        </div>
        <div class="button-row">
            <button class="btn btn-small btn-primary" onclick="saveToGitHub()">ÔøΩ Guardar en GitHub</button>
            <button class="btn btn-small btn-success" onclick="shareLog()">ÔøΩ Compartir</button>
            <button class="btn btn-small btn-warning" onclick="showTextArea()">ÔøΩ Ver texto</button>
        </div>
        <textarea id="copyArea" class="copy-area" style="display:none;" readonly onclick="this.select()"></textarea>
    </div>

    <!-- APIs Card -->
    <div class="card">
        <h2>üîß APIs</h2>
        <div id="apiSupport"></div>
    </div>

    <!-- Debug Log -->
    <div class="card">
        <h2>üìã Log Detallado</h2>
        <div id="debugLog" class="log-container"></div>
    </div>

    <script>
        // ========== LOGGING ==========
        const logEntries = [];
        const logContainer = document.getElementById('debugLog');

        function log(msg, type = 'info') {
            const ts = new Date().toLocaleTimeString('es-ES', { hour12: false }) + '.' + Date.now().toString().slice(-3);
            logEntries.push({ ts, msg, type });
            const div = document.createElement('div');
            div.className = `log-entry log-${type}`;
            div.innerHTML = `<span class="log-time">[${ts}]</span> ${msg}`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type}] ${msg}`);
        }

        function getFullLog() {
            const ua = navigator.userAgent;
            const apis = {
                showDirectoryPicker: 'showDirectoryPicker' in window,
                webkitdirectory: 'webkitdirectory' in document.createElement('input'),
                Share: 'share' in navigator
            };
            let text = `=== BYD Stats Debug ===\n`;
            text += `Fecha: ${new Date().toISOString()}\n`;
            text += `UA: ${ua}\n`;
            text += `APIs: ${JSON.stringify(apis)}\n`;
            text += `Screen: ${screen.width}x${screen.height}\n`;
            text += `Viewport: ${innerWidth}x${innerHeight}\n\n`;
            text += `=== LOG ===\n`;
            text += logEntries.map(e => `[${e.ts}] [${e.type}] ${e.msg}`).join('\n');
            return text;
        }

        function shareLog() {
            log('Intentando compartir...', 'info');
            if (!navigator.share) {
                log('Share API no disponible', 'error');
                alert('Share API no disponible en este navegador');
                return;
            }
            navigator.share({
                title: 'BYD Stats Debug Log',
                text: getFullLog()
            }).then(() => log('Compartido OK', 'success'))
                .catch(e => log('Error share: ' + e.message, 'error'));
        }

        function saveToGitHub() {
            log('Preparando para guardar en GitHub...', 'info');

            const logContent = getFullLog();
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const title = encodeURIComponent(`[Debug Log] Car test - ${timestamp}`);

            // Format body for GitHub issue
            const body = encodeURIComponent(
                `## Debug Log from Car\n\n` +
                `**Date:** ${new Date().toLocaleString()}\n\n` +
                `### System Info\n` +
                `- Browser: ${document.getElementById('gBrowser').textContent}\n` +
                `- OS: ${document.getElementById('gOS').textContent}\n` +
                `- showDirectoryPicker: ${document.getElementById('gDirPicker').textContent}\n` +
                `- webkitdirectory: ${document.getElementById('gWebkit').textContent}\n\n` +
                `### Full Log\n\`\`\`\n${logContent}\n\`\`\`\n`
            );

            const url = `https://github.com/miguelpicado/byd-stats/issues/new?title=${title}&body=${body}&labels=debug`;

            log('Abriendo GitHub...', 'info');
            window.open(url, '_blank');
            log('GitHub abierto en nueva pesta√±a', 'success');
        }

        function showTextArea() {
            const ta = document.getElementById('copyArea');
            ta.style.display = ta.style.display === 'none' ? 'block' : 'none';
            ta.value = getFullLog();
            log('Texto mostrado - selecciona y copia manualmente', 'info');
        }

        function downloadLog() {
            log('Intentando descargar...', 'info');
            try {
                const blob = new Blob([getFullLog()], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'byd-debug.txt';
                a.click();
                log('Descarga iniciada', 'success');
            } catch (e) {
                log('Error descarga: ' + e.message, 'error');
            }
        }

        // ========== SYSTEM DETECTION ==========
        function detectSystem() {
            const ua = navigator.userAgent;
            let browser = 'Unknown', bv = '?', os = 'Unknown', ov = '?';

            if (ua.includes('Chrome/')) { browser = 'Chrome'; bv = (ua.match(/Chrome\/([\d]+)/) || [])[1] || '?'; }
            else if (ua.includes('Firefox/')) { browser = 'Firefox'; bv = (ua.match(/Firefox\/([\d]+)/) || [])[1] || '?'; }
            else if (ua.includes('Safari/')) { browser = 'Safari'; bv = (ua.match(/Version\/([\d]+)/) || [])[1] || '?'; }

            if (ua.includes('Android')) { os = 'Android'; ov = (ua.match(/Android ([\d.]+)/) || [])[1] || '?'; }
            else if (ua.includes('Windows')) { os = 'Windows'; }
            else if (ua.includes('Mac OS')) { os = 'macOS'; }
            else if (ua.includes('Linux')) { os = 'Linux'; }

            document.getElementById('gBrowser').textContent = browser + ' ' + bv;
            document.getElementById('gOS').textContent = os + ' ' + ov;
            document.getElementById('gUA').textContent = 'UA: ' + ua;

            log(`Sistema: ${os} ${ov}, ${browser} ${bv}`, 'info');
            log(`UA: ${ua}`, 'debug');
        }

        function detectAPIs() {
            const apis = [
                ['showDirectoryPicker', 'showDirectoryPicker' in window],
                ['showOpenFilePicker', 'showOpenFilePicker' in window],
                ['webkitdirectory', 'webkitdirectory' in document.createElement('input')],
                ['FileReader', 'FileReader' in window],
                ['IndexedDB', 'indexedDB' in window],
                ['Clipboard', 'clipboard' in navigator],
                ['Share', 'share' in navigator],
            ];

            // Update giant summary
            const dirPicker = 'showDirectoryPicker' in window;
            const webkit = 'webkitdirectory' in document.createElement('input');

            const gDirPicker = document.getElementById('gDirPicker');
            gDirPicker.textContent = dirPicker ? '‚úÖ S√ç' : '‚ùå NO';
            gDirPicker.className = 'giant-value ' + (dirPicker ? 'giant-yes' : 'giant-no');

            const gWebkit = document.getElementById('gWebkit');
            gWebkit.textContent = webkit ? '‚úÖ S√ç' : '‚ùå NO';
            gWebkit.className = 'giant-value ' + (webkit ? 'giant-yes' : 'giant-no');

            // API badges
            document.getElementById('apiSupport').innerHTML = apis.map(([name, ok]) => {
                log(`API ${name}: ${ok ? 'S√ç' : 'NO'}`, ok ? 'success' : 'warning');
                return `<span class="badge ${ok ? 'badge-yes' : 'badge-no'}">${ok ? '‚úÖ' : '‚ùå'} ${name}</span>`;
            }).join('');
        }

        // ========== TEST FUNCTIONS ==========
        async function testShowDirectoryPicker() {
            log('=== TEST: showDirectoryPicker ===', 'info');

            if (!('showDirectoryPicker' in window)) {
                log('‚ùå showDirectoryPicker NO disponible', 'error');
                showResult('ERROR', 0, 0, false, 'showDirectoryPicker no disponible');
                return;
            }

            try {
                log('Abriendo selector de carpeta...', 'info');
                const handle = await window.showDirectoryPicker({ mode: 'read' });
                log(`Carpeta: "${handle.name}"`, 'success');

                const files = [];
                for await (const entry of handle.values()) {
                    if (entry.kind === 'file') {
                        try {
                            const f = await entry.getFile();
                            files.push({ name: f.name, size: f.size });
                            log(`  üìÑ ${f.name} (${(f.size / 1024).toFixed(1)}KB)`, 'debug');
                        } catch (e) { log(`  ‚ùå Error: ${entry.name}`, 'error'); }
                    }
                }

                const dbs = files.filter(f => f.name.toLowerCase().endsWith('.db'));
                const ec = files.find(f => f.name.toLowerCase() === 'ec_database.db');

                showResult(handle.name, files.length, dbs.length, !!ec, '', files);
                log(`Total: ${files.length} archivos, ${dbs.length} .db, EC_Database: ${ec ? 'S√ç' : 'NO'}`, ec ? 'success' : 'warning');

            } catch (e) {
                log(`Error: ${e.name} - ${e.message}`, 'error');
                if (e.name === 'AbortError') log('Usuario cancel√≥', 'warning');
            }
        }

        function testWebkitDirectory() {
            log('=== TEST: webkitdirectory ===', 'info');
            document.getElementById('folderInput').click();
        }

        function testFileInput() {
            log('=== TEST: File Input ===', 'info');
            document.getElementById('fileInput').click();
        }

        document.getElementById('folderInput').addEventListener('change', function (e) {
            const files = Array.from(e.target.files).map(f => ({
                name: f.name,
                path: f.webkitRelativePath,
                size: f.size
            }));

            log(`webkitdirectory: ${files.length} archivos`, 'success');
            files.slice(0, 20).forEach(f => log(`  üìÑ ${f.path || f.name}`, 'debug'));

            const dbs = files.filter(f => f.name.toLowerCase().endsWith('.db'));
            const ec = files.find(f => f.name.toLowerCase() === 'ec_database.db');

            showResult('webkitdirectory', files.length, dbs.length, !!ec, '', files);
            log(`Total: ${files.length}, .db: ${dbs.length}, EC: ${ec ? 'S√ç' : 'NO'}`, ec ? 'success' : 'warning');
            e.target.value = '';
        });

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const files = Array.from(e.target.files);
            log(`File input: ${files.length} archivos`, 'success');
            files.forEach(f => log(`  üìÑ ${f.name} (${(f.size / 1024).toFixed(1)}KB, tipo: ${f.type || 'sin tipo'})`, 'debug'));

            const dbs = files.filter(f => f.name.toLowerCase().endsWith('.db'));
            const ec = files.find(f => f.name.toLowerCase() === 'ec_database.db');

            showResult('fileInput', files.length, dbs.length, !!ec, '', files.map(f => ({ name: f.name, size: f.size })));
            e.target.value = '';
        });

        function showResult(title, total, dbs, hasEC, error, files = []) {
            const container = document.getElementById('testResults');
            container.style.display = 'block';
            container.style.borderColor = hasEC ? '#4ade80' : (error ? '#f87171' : '#fbbf24');

            document.getElementById('resultTitle').textContent = error ? '‚ùå ' + error : 'üìÅ ' + title;
            document.getElementById('rFiles').textContent = total;

            const rDB = document.getElementById('rDB');
            rDB.textContent = dbs;
            rDB.className = 'giant-value ' + (dbs > 0 ? 'giant-yes' : 'giant-no');

            const rEC = document.getElementById('rEC');
            rEC.textContent = hasEC ? '‚úÖ ENCONTRADO' : '‚ùå NO';
            rEC.className = 'giant-value ' + (hasEC ? 'giant-yes' : 'giant-no');

            // File list
            const listEl = document.getElementById('rFileList');
            if (files.length > 0) {
                listEl.innerHTML = '<strong>Archivos:</strong><br>' +
                    files.slice(0, 30).map(f => {
                        const isDb = f.name.toLowerCase().endsWith('.db');
                        const isEC = f.name.toLowerCase() === 'ec_database.db';
                        return `<span style="color: ${isEC ? '#4ade80' : (isDb ? '#fbbf24' : '#94a3b8')}">${isEC ? 'üéØ ' : ''}${f.path || f.name}</span>`;
                    }).join('<br>') + (files.length > 30 ? `<br>... y ${files.length - 30} m√°s` : '');
            } else {
                listEl.innerHTML = '';
            }
        }

        // ========== INIT ==========
        log('=== Debug iniciado ===', 'info');
        log(`Fecha: ${new Date().toISOString()}`, 'info');
        log(`URL: ${location.href}`, 'debug');
        log(`Seguro: ${window.isSecureContext}`, window.isSecureContext ? 'success' : 'warning');

        detectSystem();
        detectAPIs();

        log('Listo para pruebas', 'success');
    </script>
</body>

</html>