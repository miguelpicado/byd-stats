<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug FULL - BYD Stats</title>
    <link rel="manifest" href="/prueba/manifest.json">
    <meta name="theme-color" content="#ea0029">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        body {
            font-family: system-ui, sans-serif;
            background: #0f172a;
            color: #fff;
            padding: 8px;
            font-size: 12px
        }

        h1 {
            color: #ea0029;
            text-align: center;
            font-size: 1rem;
            margin: 8px 0
        }

        h2 {
            font-size: 0.8rem;
            color: #94a3b8;
            margin: 4px 0
        }

        .c {
            background: #1e293b;
            border-radius: 8px;
            padding: 8px;
            margin: 4px 0;
            border: 1px solid #334155
        }

        .btn {
            width: 100%;
            padding: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 3px 0;
            color: #fff
        }

        .r {
            background: #ea0029
        }

        .g {
            background: #059669
        }

        .y {
            background: #d97706
        }

        .b {
            background: #0284c7
        }

        .gr {
            background: #475569
        }

        .sm {
            padding: 6px 10px;
            width: auto;
            font-size: 0.7rem
        }

        input[type=file] {
            display: none
        }

        input[type=text] {
            width: 100%;
            padding: 8px;
            background: #0f172a;
            border: 1px solid #475569;
            color: #fff;
            border-radius: 4px;
            margin: 4px 0;
            font-size: 11px
        }

        .log {
            background: #0f172a;
            border-radius: 4px;
            padding: 6px;
            font-family: monospace;
            font-size: 9px;
            max-height: 180px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all
        }

        .log-i {
            color: #60a5fa
        }

        .log-s {
            color: #4ade80
        }

        .log-e {
            color: #f87171
        }

        .log-w {
            color: #fbbf24
        }

        .drop {
            border: 2px dashed #475569;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 4px 0
        }

        .drop.active {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.1)
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px
        }

        .result {
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            margin: 6px 0
        }

        .result.ok {
            border-color: #4ade80
        }

        .result.err {
            border-color: #f87171
        }

        .info {
            font-size: 0.7rem;
            color: #64748b;
            margin: 2px 0
        }

        .flex {
            display: flex;
            gap: 4px;
            flex-wrap: wrap
        }

        .tag {
            background: #334155;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            margin: 1px
        }

        .tag.ok {
            background: #059669
        }

        .tag.no {
            background: #dc2626
        }
    </style>
</head>

<body>
    <h1>üî¨ Debug COMPLETO - Todas las opciones</h1>

    <!-- M√âTODO 1: PWA Share Target -->
    <div class="c">
        <h2>1Ô∏è‚É£ PWA Share Target</h2>
        <p class="info">Instala como PWA, luego comparte desde explorador de archivos</p>
        <button class="btn b" onclick="installPWA()">üì≤ Instalar como PWA</button>
        <button class="btn gr" onclick="checkPWA()">üîç Verificar estado PWA</button>
        <div id="pwa-result"></div>
    </div>

    <!-- M√âTODO 2: Drag & Drop -->
    <div class="c">
        <h2>2Ô∏è‚É£ Drag & Drop</h2>
        <div id="drop" class="drop">üìÅ Arrastra archivo aqu√≠</div>
    </div>

    <!-- M√âTODO 3: Input File Variants -->
    <div class="c">
        <h2>3Ô∏è‚É£ Input File (variantes)</h2>
        <div class="grid">
            <button class="btn gr sm" onclick="$('f1').click()">*/*</button>
            <button class="btn gr sm" onclick="$('f2').click()">sin accept</button>
            <button class="btn gr sm" onclick="$('f3').click()">.db,.sqlite</button>
            <button class="btn gr sm" onclick="$('f4').click()">octet-stream</button>
            <button class="btn gr sm" onclick="$('f5').click()">capture=env</button>
            <button class="btn gr sm" onclick="$('f6').click()">webkitdir</button>
        </div>
        <input type="file" id="f1" accept="*/*" onchange="onFile(this,'*/*')">
        <input type="file" id="f2" onchange="onFile(this,'sin accept')">
        <input type="file" id="f3" accept=".db,.sqlite,.sqlite3,application/x-sqlite3" onchange="onFile(this,'.db')">
        <input type="file" id="f4" accept="application/octet-stream" onchange="onFile(this,'octet-stream')">
        <input type="file" id="f5" capture="environment" onchange="onFile(this,'capture')">
        <input type="file" id="f6" webkitdirectory onchange="onFile(this,'webkitdir')">
    </div>

    <!-- M√âTODO 4: URL Schemes -->
    <div class="c">
        <h2>4Ô∏è‚É£ URL Schemes</h2>
        <button class="btn gr" onclick="tryURL('file:///storage/emulated/0/energydata/EC_Database.db')">file://
            energydata</button>
        <button class="btn gr" onclick="tryURL('file:///sdcard/energydata/EC_Database.db')">file:// sdcard</button>
        <button class="btn gr" onclick="tryURL('file:///data/energydata/EC_Database.db')">file:// data</button>
        <input type="text" id="customUrl" placeholder="URL personalizada (file://, content://, http://)">
        <button class="btn y" onclick="tryURL($('customUrl').value)">üîó Probar URL</button>
    </div>

    <!-- M√âTODO 5: Network Fetch -->
    <div class="c">
        <h2>5Ô∏è‚É£ Red Local (HTTP)</h2>
        <p class="info">Si tienes servidor HTTP en la red local</p>
        <input type="text" id="netUrl" placeholder="http://192.168.1.100:8080/EC_Database.db">
        <button class="btn g" onclick="fetchNet()">üì° Descargar de red</button>
    </div>

    <!-- M√âTODO 6: Clipboard -->
    <div class="c">
        <h2>6Ô∏è‚É£ Clipboard</h2>
        <button class="btn y" onclick="readClipboard()">üìã Leer portapapeles</button>
        <button class="btn gr" onclick="readClipboardFiles()">üìé Leer archivos del clipboard</button>
    </div>

    <!-- M√âTODO 7: Intent URL -->
    <div class="c">
        <h2>7Ô∏è‚É£ Intent URL (Android)</h2>
        <p class="info">Abrir con intent:// scheme</p>
        <button class="btn gr" onclick="tryIntent()">ü§ñ Probar intent://</button>
    </div>

    <!-- M√âTODO 8: iframe file:// -->
    <div class="c">
        <h2>8Ô∏è‚É£ iframe file://</h2>
        <button class="btn gr" onclick="tryIframe()">üìÑ Cargar en iframe</button>
        <iframe id="fileFrame"
            style="width:100%;height:50px;background:#0f172a;border:1px solid #475569;display:none"></iframe>
    </div>

    <!-- M√âTODO 9: XMLHttpRequest file:// -->
    <div class="c">
        <h2>9Ô∏è‚É£ XMLHttpRequest file://</h2>
        <button class="btn gr" onclick="tryXHR()">üìÑ XHR a file://</button>
    </div>

    <!-- M√âTODO 10: window.open file:// -->
    <div class="c">
        <h2>üîü window.open file://</h2>
        <button class="btn gr" onclick="tryWindowOpen()">ü™ü Abrir file:// en nueva ventana</button>
    </div>

    <!-- M√âTODO 11: location.href file:// -->
    <div class="c">
        <h2>1Ô∏è‚É£1Ô∏è‚É£ Navegar a file://</h2>
        <button class="btn gr" onclick="tryNavigate()">üß≠ Navegar a file:// (cuidado!)</button>
    </div>

    <!-- M√âTODO 12: BroadcastChannel -->
    <div class="c">
        <h2>1Ô∏è‚É£2Ô∏è‚É£ BroadcastChannel</h2>
        <p class="info">Recibir datos de otra pesta√±a</p>
        <button class="btn gr" onclick="setupBroadcast()">üì¢ Escuchar BroadcastChannel</button>
        <div id="broadcast-status"></div>
    </div>

    <!-- M√âTODO 13: postMessage -->
    <div class="c">
        <h2>1Ô∏è‚É£3Ô∏è‚É£ postMessage</h2>
        <p class="info">Si otra ventana/app puede enviar mensajes</p>
        <button class="btn gr" onclick="setupPostMessage()">üí¨ Escuchar postMessage</button>
    </div>

    <!-- M√âTODO 14: WebSocket local -->
    <div class="c">
        <h2>1Ô∏è‚É£4Ô∏è‚É£ WebSocket Local</h2>
        <input type="text" id="wsUrl" placeholder="ws://192.168.1.100:8080">
        <button class="btn gr" onclick="tryWebSocket()">üîå Conectar WebSocket</button>
    </div>

    <!-- M√âTODO 15: Check for file managers -->
    <div class="c">
        <h2>1Ô∏è‚É£5Ô∏è‚É£ Detectar Apps</h2>
        <button class="btn b" onclick="detectApps()">üîç Detectar apps/intents disponibles</button>
    </div>

    <!-- APIs disponibles -->
    <div class="c">
        <h2>üìä APIs Detectadas</h2>
        <div id="apis" class="flex"></div>
    </div>

    <!-- Export -->
    <div class="c">
        <h2>üì§ Exportar</h2>
        <div class="flex">
            <button class="btn sm r" onclick="toGH()">üêô GitHub</button>
            <button class="btn sm g" onclick="share()">üì§ Share</button>
            <button class="btn sm y" onclick="copy()">üìã Copy</button>
        </div>
    </div>

    <!-- Log -->
    <div class="c">
        <h2>üìã Log</h2>
        <div id="log" class="log"></div>
    </div>

    <!-- Result display -->
    <div id="mainResult" class="result" style="display:none"></div>

    <script>
        const $ = id => document.getElementById(id);
        const logs = [];
        const logEl = $('log');

        function log(m, t = 'i') {
            const ts = new Date().toLocaleTimeString('es', { hour12: 0 });
            logs.push({ ts, m, t });
            const d = document.createElement('div');
            d.className = 'log-' + t;
            d.textContent = `[${ts}] ${m}`;
            logEl.appendChild(d);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${t}]`, m);
        }

        function showResult(msg, ok) {
            const r = $('mainResult');
            r.style.display = 'block';
            r.className = 'result ' + (ok ? 'ok' : 'err');
            r.innerHTML = msg;
            setTimeout(() => r.scrollIntoView({ behavior: 'smooth' }), 100);
        }

        // 1. PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; log('PWA instalable!', 's') });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(r => log('Instalaci√≥n: ' + r.outcome, r.outcome === 'accepted' ? 's' : 'w'));
            } else {
                log('No hay prompt. Usa men√∫ Chrome ‚Üí A√±adir a inicio', 'w');
            }
        }

        function checkPWA() {
            log('Verificando PWA...', 'i');
            const standalone = window.matchMedia('(display-mode:standalone)').matches;
            log('Standalone: ' + standalone, standalone ? 's' : 'w');
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(r => {
                    log('SW registrado: ' + (r ? r.scope : 'NO'), r ? 's' : 'w');
                });
            }
            $('pwa-result').innerHTML = '<div class="tag ' + (standalone ? 'ok' : 'no') + '">' + (standalone ? '‚úÖ PWA activa' : '‚ùå No es PWA') + '</div>';
        }

        // 2. Drag & Drop
        const drop = $('drop');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => drop.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation() }));
        ['dragenter', 'dragover'].forEach(e => drop.addEventListener(e, () => { drop.classList.add('active'); log('Drag detectado', 'i') }));
        ['dragleave', 'drop'].forEach(e => drop.addEventListener(e, () => drop.classList.remove('active')));
        drop.addEventListener('drop', e => {
            log('Drop event!', 'i');
            const dt = e.dataTransfer;
            log('Tipos: ' + [...dt.types].join(', '), 'i');
            if (dt.files.length) {
                const f = dt.files[0];
                log(`Archivo: ${f.name}, ${f.size}b, ${f.type}`, 's');
                processFile(f);
            } else {
                log('No hay archivos en drop', 'w');
            }
        });

        // 3. File inputs
        function onFile(inp, src) {
            if (inp.files.length) {
                const f = inp.files[0];
                log(`[${src}] ${f.name}, ${f.size}b, ${f.type || 'sin tipo'}`, 's');
                processFile(f);
            }
            inp.value = '';
        }

        // 4-11. URL/fetch methods
        async function tryURL(url) {
            if (!url) { log('URL vac√≠a', 'w'); return }
            log('Probando: ' + url, 'i');
            try {
                const r = await fetch(url);
                if (!r.ok) throw new Error('HTTP ' + r.status);
                const b = await r.blob();
                log('√âxito! ' + b.size + ' bytes', 's');
                processBlob(b, 'fetched.db');
                showResult('‚úÖ URL funcion√≥: ' + b.size + ' bytes', true);
            } catch (e) {
                log('Error: ' + e.message, 'e');
                showResult('‚ùå ' + e.message, false);
            }
        }

        async function fetchNet() {
            const url = $('netUrl').value;
            if (!url) { log('Ingresa URL', 'w'); return }
            log('Conectando a ' + url, 'i');
            try {
                const r = await fetch(url, { mode: 'cors' });
                const b = await r.blob();
                log('Descargado: ' + b.size + ' bytes', 's');
                processBlob(b, 'network.db');
                showResult('‚úÖ Red funcion√≥: ' + b.size + ' bytes', true);
            } catch (e) {
                log('Error red: ' + e.message, 'e');
                showResult('‚ùå Red: ' + e.message, false);
            }
        }

        // 6. Clipboard
        async function readClipboard() {
            log('Leyendo clipboard...', 'i');
            try {
                const t = await navigator.clipboard.readText();
                log('Texto: ' + t.substring(0, 100) + '...', 's');
            } catch (e) { log('Error: ' + e.message, 'e') }
        }

        async function readClipboardFiles() {
            log('Leyendo archivos clipboard...', 'i');
            try {
                if (!navigator.clipboard.read) { log('clipboard.read() no disponible', 'e'); return }
                const items = await navigator.clipboard.read();
                log('Items: ' + items.length, 'i');
                for (const item of items) {
                    log('Tipos: ' + item.types.join(', '), 'i');
                    for (const type of item.types) {
                        const blob = await item.getType(type);
                        log(`${type}: ${blob.size}b`, 's');
                        if (blob.size > 1000) processBlob(blob, 'clipboard');
                    }
                }
            } catch (e) { log('Error: ' + e.message, 'e') }
        }

        // 7. Intent
        function tryIntent() {
            const url = 'intent://energydata/EC_Database.db#Intent;scheme=file;end';
            log('Probando: ' + url, 'i');
            try {
                window.location.href = url;
            } catch (e) { log('Error: ' + e.message, 'e') }
        }

        // 8. iframe
        function tryIframe() {
            const url = 'file:///storage/emulated/0/energydata/EC_Database.db';
            log('Cargando en iframe: ' + url, 'i');
            const f = $('fileFrame');
            f.style.display = 'block';
            f.src = url;
            f.onload = () => log('iframe cargado', 's');
            f.onerror = () => log('iframe error', 'e');
        }

        // 9. XHR
        function tryXHR() {
            const url = 'file:///storage/emulated/0/energydata/EC_Database.db';
            log('XHR a: ' + url, 'i');
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url);
            xhr.responseType = 'blob';
            xhr.onload = () => { log('XHR √©xito: ' + xhr.response.size + 'b', 's'); processBlob(xhr.response, 'xhr.db') };
            xhr.onerror = () => log('XHR error', 'e');
            try { xhr.send() } catch (e) { log('XHR exception: ' + e.message, 'e') }
        }

        // 10. window.open
        function tryWindowOpen() {
            const url = 'file:///storage/emulated/0/energydata/EC_Database.db';
            log('window.open: ' + url, 'i');
            try {
                const w = window.open(url, '_blank');
                log(w ? 'Ventana abierta' : 'Bloqueado', w ? 's' : 'e');
            } catch (e) { log('Error: ' + e.message, 'e') }
        }

        // 11. Navigate
        function tryNavigate() {
            if (!confirm('Esto navegar√° fuera de la p√°gina. ¬øContinuar?')) return;
            const url = 'file:///storage/emulated/0/energydata/EC_Database.db';
            log('Navegando a: ' + url, 'i');
            window.location.href = url;
        }

        // 12. BroadcastChannel
        function setupBroadcast() {
            log('Configurando BroadcastChannel...', 'i');
            if (!('BroadcastChannel' in window)) { log('No disponible', 'e'); return }
            const bc = new BroadcastChannel('bydstats');
            bc.onmessage = e => {
                log('Mensaje recibido!', 's');
                log(JSON.stringify(e.data).substring(0, 200), 'i');
            };
            log('Escuchando en canal "bydstats"', 's');
            $('broadcast-status').innerHTML = '<div class="tag ok">‚úÖ Escuchando</div>';
        }

        // 13. postMessage
        function setupPostMessage() {
            log('Configurando postMessage...', 'i');
            window.addEventListener('message', e => {
                log('postMessage recibido de ' + e.origin, 's');
                log(JSON.stringify(e.data).substring(0, 200), 'i');
            });
            log('Escuchando postMessage', 's');
        }

        // 14. WebSocket
        function tryWebSocket() {
            const url = $('wsUrl').value;
            if (!url) { log('Ingresa URL WS', 'w'); return }
            log('Conectando WS: ' + url, 'i');
            try {
                const ws = new WebSocket(url);
                ws.onopen = () => log('WS conectado!', 's');
                ws.onmessage = e => log('WS mensaje: ' + e.data.substring(0, 100), 's');
                ws.onerror = () => log('WS error', 'e');
                ws.onclose = () => log('WS cerrado', 'w');
            } catch (e) { log('WS exception: ' + e.message, 'e') }
        }

        // 15. Detect apps
        function detectApps() {
            log('Detectando capacidades...', 'i');
            const tests = [
                ['canShare', navigator.canShare?.({ files: [new File([''], 't.txt')] })],
                ['registerProtocolHandler', 'registerProtocolHandler' in navigator],
                ['getInstalledRelatedApps', 'getInstalledRelatedApps' in navigator],
            ];
            tests.forEach(([n, v]) => log(`${n}: ${v}`, 'i'));

            if ('getInstalledRelatedApps' in navigator) {
                navigator.getInstalledRelatedApps().then(apps => {
                    log('Apps relacionadas: ' + apps.length, 'i');
                    apps.forEach(a => log(' - ' + a.platform + ': ' + a.url, 'i'));
                }).catch(e => log('Error: ' + e.message, 'e'));
            }
        }

        // Process file
        function processFile(f) {
            log('Procesando ' + f.name + '...', 'i');
            const r = new FileReader();
            r.onload = () => {
                const arr = new Uint8Array(r.result.slice(0, 16));
                const hdr = String.fromCharCode(...arr);
                if (hdr.includes('SQLite')) {
                    log('‚úÖ ¬°SQLite v√°lido!', 's');
                    showResult('‚úÖ ¬°Archivo SQLite v√°lido! ' + f.size + ' bytes', true);
                } else {
                    log('Header: ' + hdr, 'w');
                    showResult('‚ö†Ô∏è No parece SQLite, pero recibido: ' + f.size + ' bytes', false);
                }
            };
            r.readAsArrayBuffer(f);
        }

        function processBlob(b, name) { processFile(new File([b], name)) }

        // Detect APIs
        function detectAPIs() {
            const apis = [
                ['showDirectoryPicker', 'showDirectoryPicker' in window],
                ['showOpenFilePicker', 'showOpenFilePicker' in window],
                ['webkitdirectory', 'webkitdirectory' in document.createElement('input')],
                ['FileReader', 'FileReader' in window],
                ['Blob', 'Blob' in window],
                ['IndexedDB', 'indexedDB' in window],
                ['localStorage', 'localStorage' in window],
                ['Clipboard', 'clipboard' in navigator],
                ['Share', 'share' in navigator],
                ['BroadcastChannel', 'BroadcastChannel' in window],
                ['WebSocket', 'WebSocket' in window],
                ['ServiceWorker', 'serviceWorker' in navigator],
            ];
            $('apis').innerHTML = apis.map(([n, ok]) => {
                log(`API ${n}: ${ok ? 'S√ç' : 'NO'}`, ok ? 's' : 'w');
                return `<span class="tag ${ok ? 'ok' : 'no'}">${ok ? '‚úÖ' : '‚ùå'} ${n}</span>`;
            }).join('');
        }

        // Export
        function getLog() { return logs.map(l => `[${l.ts}][${l.t}] ${l.m}`).join('\n') }
        function toGH() {
            const b = encodeURIComponent('```\n' + getLog() + '\n```');
            const t = encodeURIComponent('[Debug FULL] ' + new Date().toISOString());
            window.open(`https://github.com/miguelpicado/byd-stats/issues/new?title=${t}&body=${b}&labels=debug`, '_blank');
        }
        function share() { navigator.share?.({ title: 'Debug', text: getLog() }) || log('Share no disponible', 'e') }
        function copy() { navigator.clipboard.writeText(getLog()).then(() => log('Copiado', 's')).catch(e => log(e.message, 'e')) }

        // Check URL params for share target
        function checkShareTarget() {
            const p = new URLSearchParams(location.search);
            if (p.has('file') || p.has('shared') || p.has('text') || p.has('filename')) {
                log('¬°Datos recibidos via Share Target!', 's');
                log('Params: ' + location.search, 'i');

                // Check IndexedDB for shared file
                checkIndexedDBForFile();
            }
        }

        // Check IndexedDB for files from Service Worker
        async function checkIndexedDBForFile() {
            log('Buscando archivo en IndexedDB...', 'i');
            try {
                const db = await new Promise((resolve, reject) => {
                    const request = indexedDB.open('byd-debug', 1);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = e => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('files')) {
                            db.createObjectStore('files', { keyPath: 'id' });
                        }
                    };
                });

                const tx = db.transaction('files', 'readonly');
                const store = tx.objectStore('files');
                const file = await new Promise((resolve, reject) => {
                    const request = store.get('shared-file');
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                if (file) {
                    log('¬°Archivo encontrado en IndexedDB!', 's');
                    log(`Nombre: ${file.name}, Tama√±o: ${file.size}b`, 's');

                    // Process the file
                    const blob = new Blob([file.data]);
                    processBlob(blob, file.name);

                    showResult('‚úÖ ¬°Archivo recibido via Share! ' + file.name + ' (' + file.size + ' bytes)', true);
                } else {
                    log('No hay archivo en IndexedDB', 'w');
                }
            } catch (e) {
                log('Error IndexedDB: ' + e.message, 'e');
            }
        }

        // Register Service Worker
        async function registerSW() {
            if ('serviceWorker' in navigator) {
                try {
                    const reg = await navigator.serviceWorker.register('/prueba/sw.js', { scope: '/prueba/' });
                    log('Service Worker registrado: ' + reg.scope, 's');
                } catch (e) {
                    log('Error registrando SW: ' + e.message, 'e');
                }
            } else {
                log('ServiceWorker no disponible', 'w');
            }
        }

        // Init
        log('Debug FULL iniciado', 'i');
        log('UA: ' + navigator.userAgent, 'i');
        log('Secure: ' + window.isSecureContext, 'i');
        registerSW();
        detectAPIs();
        checkShareTarget();
        checkPWA();
        setupPostMessage();
    </script>
</body>

</html>