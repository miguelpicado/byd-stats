<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug v2 - BYD Stats</title>
    <!-- PWA Manifest for Share Target -->
    <link rel="manifest" href="/prueba/manifest.json">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: #0f172a;
            color: white;
            min-height: 100vh;
            padding: 10px;
            font-size: 13px;
        }

        h1 {
            color: #ea0029;
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-bottom: 6px;
        }

        .card {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 10px;
            padding: 10px;
            margin: 6px 0;
            border: 1px solid #334155;
        }

        .btn {
            width: 100%;
            padding: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 4px 0;
        }

        .btn-primary {
            background: #ea0029;
            color: white;
        }

        .btn-secondary {
            background: #334155;
            color: white;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-warning {
            background: #d97706;
            color: white;
        }

        .btn-info {
            background: #0284c7;
            color: white;
        }

        input[type="file"] {
            display: none;
        }

        .log-container {
            background: #0f172a;
            border-radius: 6px;
            padding: 8px;
            font-family: monospace;
            font-size: 10px;
            max-height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-entry {
            margin: 1px 0;
        }

        .log-info {
            color: #60a5fa;
        }

        .log-success {
            color: #4ade80;
        }

        .log-error {
            color: #f87171;
        }

        .log-warning {
            color: #fbbf24;
        }

        .result-box {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            text-align: center;
        }

        .result-success {
            border-color: #4ade80;
        }

        .result-error {
            border-color: #f87171;
        }

        .drop-zone {
            border: 3px dashed #475569;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
        }

        .drop-zone.active {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }

        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .button-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 0.75rem;
            width: auto;
        }

        .info-text {
            font-size: 0.75rem;
            color: #94a3b8;
            margin: 4px 0;
        }
    </style>
</head>

<body>
    <h1>üî¨ Debug v2 - Alternativas</h1>

    <!-- Share Target Test -->
    <div class="card">
        <h2>üì§ Test 1: Share Target API</h2>
        <p class="info-text">Si la webapp est√° instalada como PWA, puede recibir archivos "compartidos" desde otras apps
        </p>
        <button class="btn btn-info" onclick="checkShareTarget()">Verificar Share Target</button>
        <button class="btn btn-secondary" onclick="installPWA()">Instalar como PWA</button>
        <div id="shareTargetResult"></div>
    </div>

    <!-- Drag and Drop Zone -->
    <div class="card">
        <h2>üéØ Test 2: Drag and Drop</h2>
        <p class="info-text">Arrastra EC_Database.db desde otra app/ventana aqu√≠</p>
        <div id="dropZone" class="drop-zone">
            üìÅ Arrastra el archivo aqu√≠
        </div>
        <div id="dropResult"></div>
    </div>

    <!-- URL Parameter Test -->
    <div class="card">
        <h2>üîó Test 3: URL con archivo</h2>
        <p class="info-text">Probar si acepta file:// o content:// URIs</p>
        <button class="btn btn-secondary" onclick="testFileURL()">Probar file:// URL</button>
        <button class="btn btn-secondary" onclick="testContentURL()">Probar content:// URL</button>
        <input type="text" id="customURL" placeholder="Pega una URL aqu√≠"
            style="width:100%; padding:8px; margin-top:8px; background:#1e293b; border:1px solid #475569; color:white; border-radius:6px;">
        <button class="btn btn-warning" onclick="testCustomURL()">Probar URL personalizada</button>
    </div>

    <!-- Fetch from local network -->
    <div class="card">
        <h2>üì° Test 4: Red local (m√≥vil como servidor)</h2>
        <p class="info-text">Si tienes el archivo en un servidor HTTP local (m√≥vil o PC)</p>
        <input type="text" id="localURL" placeholder="http://192.168.1.x:8080/EC_Database.db"
            style="width:100%; padding:8px; background:#1e293b; border:1px solid #475569; color:white; border-radius:6px;">
        <button class="btn btn-success" onclick="fetchFromNetwork()">Descargar desde red</button>
        <div id="networkResult"></div>
    </div>

    <!-- Clipboard paste -->
    <div class="card">
        <h2>üìã Test 5: Pegar desde portapapeles</h2>
        <p class="info-text">Copia el archivo en otra app y p√©galo aqu√≠</p>
        <button class="btn btn-warning" onclick="pasteFromClipboard()">Pegar archivo</button>
        <div id="clipboardResult"></div>
    </div>

    <!-- Accept any file type -->
    <div class="card">
        <h2>üìÑ Test 6: Input sin restricciones</h2>
        <p class="info-text">Diferentes configuraciones de input file</p>
        <button class="btn btn-secondary" onclick="document.getElementById('input1').click()">accept="*/*"</button>
        <input type="file" id="input1" accept="*/*" onchange="handleFile(this, 'accept=*/*')">

        <button class="btn btn-secondary" onclick="document.getElementById('input2').click()">accept="" (vac√≠o)</button>
        <input type="file" id="input2" accept="" onchange="handleFile(this, 'accept vac√≠o')">

        <button class="btn btn-secondary" onclick="document.getElementById('input3').click()">Sin accept</button>
        <input type="file" id="input3" onchange="handleFile(this, 'sin accept')">

        <button class="btn btn-secondary"
            onclick="document.getElementById('input4').click()">accept="application/octet-stream"</button>
        <input type="file" id="input4" accept="application/octet-stream" onchange="handleFile(this, 'octet-stream')">

        <button class="btn btn-secondary"
            onclick="document.getElementById('input5').click()">capture="environment"</button>
        <input type="file" id="input5" capture="environment" onchange="handleFile(this, 'capture')">
    </div>

    <!-- Export Options -->
    <div class="card">
        <div class="section-title">
            <h2>üì§ Exportar Log</h2>
        </div>
        <div class="button-row">
            <button class="btn btn-small btn-primary" onclick="saveToGitHub()">üêô GitHub Issue</button>
            <button class="btn btn-small btn-success" onclick="shareLog()">üì§ Compartir</button>
            <button class="btn btn-small btn-warning" onclick="copyLog()">üìã Copiar</button>
        </div>
    </div>

    <!-- Debug Log -->
    <div class="card">
        <h2>üìã Log</h2>
        <div id="debugLog" class="log-container"></div>
    </div>

    <script>
        // Logging
        const logEntries = [];
        const logContainer = document.getElementById('debugLog');

        function log(msg, type = 'info') {
            const ts = new Date().toLocaleTimeString('es-ES', { hour12: false });
            logEntries.push({ ts, msg, type });
            const div = document.createElement('div');
            div.className = `log-entry log-${type}`;
            div.textContent = `[${ts}] ${msg}`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type}] ${msg}`);
        }

        // Check URL parameters (for Share Target)
        function checkURLParams() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('shared') || params.has('file')) {
                log('¬°Archivo recibido via URL params!', 'success');
                log('Params: ' + window.location.search, 'info');
            }
        }

        // Share Target check
        function checkShareTarget() {
            log('Verificando Share Target...', 'info');

            if ('share' in navigator) {
                log('Share API disponible', 'success');
            }

            if ('serviceWorker' in navigator) {
                log('Service Worker disponible', 'success');
                navigator.serviceWorker.getRegistration().then(reg => {
                    if (reg) {
                        log('PWA registrada: ' + reg.scope, 'success');
                    } else {
                        log('PWA no registrada', 'warning');
                    }
                });
            }

            // Check if running as PWA
            if (window.matchMedia('(display-mode: standalone)').matches) {
                log('Ejecutando como PWA instalada', 'success');
            } else {
                log('Ejecutando en navegador normal', 'info');
            }
        }

        // Install PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            log('PWA instalable detectada', 'success');
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(result => {
                    log('Resultado instalaci√≥n: ' + result.outcome, result.outcome === 'accepted' ? 'success' : 'warning');
                });
            } else {
                log('No hay prompt de instalaci√≥n disponible', 'warning');
                log('Intenta: Menu Chrome ‚Üí "A√±adir a pantalla inicio"', 'info');
            }
        }

        // Drag and Drop
        const dropZone = document.getElementById('dropZone');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
            dropZone.addEventListener(event, e => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        ['dragenter', 'dragover'].forEach(event => {
            dropZone.addEventListener(event, () => {
                dropZone.classList.add('active');
                log('Archivo detectado sobre la zona', 'info');
            });
        });

        ['dragleave', 'drop'].forEach(event => {
            dropZone.addEventListener(event, () => {
                dropZone.classList.remove('active');
            });
        });

        dropZone.addEventListener('drop', e => {
            log('=== DROP EVENT ===', 'info');
            const dt = e.dataTransfer;

            log('Tipos: ' + Array.from(dt.types).join(', '), 'info');

            if (dt.files.length > 0) {
                const file = dt.files[0];
                log(`Archivo: ${file.name}, ${file.size} bytes, tipo: ${file.type}`, 'success');
                processFile(file);
            } else {
                log('No se detectaron archivos en el drop', 'warning');

                // Check for other data types
                dt.types.forEach(type => {
                    const data = dt.getData(type);
                    log(`Tipo ${type}: ${data.substring(0, 100)}...`, 'info');
                });
            }
        });

        // File URL tests
        function testFileURL() {
            const url = 'file:///storage/emulated/0/energydata/EC_Database.db';
            log('Probando: ' + url, 'info');

            fetch(url)
                .then(r => {
                    log('Fetch exitoso!', 'success');
                    return r.blob();
                })
                .then(blob => log('Blob: ' + blob.size + ' bytes', 'success'))
                .catch(e => log('Error: ' + e.message, 'error'));
        }

        function testContentURL() {
            log('content:// requiere ser pasado desde otra app', 'warning');
            log('No se puede construir manualmente', 'info');
        }

        function testCustomURL() {
            const url = document.getElementById('customURL').value;
            if (!url) {
                log('Ingresa una URL primero', 'warning');
                return;
            }

            log('Probando: ' + url, 'info');
            fetch(url)
                .then(r => r.blob())
                .then(blob => {
                    log('√âxito! ' + blob.size + ' bytes', 'success');
                    processBlob(blob, 'custom-file');
                })
                .catch(e => log('Error: ' + e.message, 'error'));
        }

        // Network fetch
        function fetchFromNetwork() {
            const url = document.getElementById('localURL').value;
            if (!url) {
                log('Ingresa la URL del servidor', 'warning');
                return;
            }

            log('Conectando a: ' + url, 'info');

            fetch(url, { mode: 'cors' })
                .then(r => {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.blob();
                })
                .then(blob => {
                    log('¬°Descargado! ' + blob.size + ' bytes', 'success');
                    processBlob(blob, 'network-file.db');
                    document.getElementById('networkResult').innerHTML =
                        '<div class="result-box result-success">‚úÖ Archivo descargado: ' + blob.size + ' bytes</div>';
                })
                .catch(e => {
                    log('Error de red: ' + e.message, 'error');
                    document.getElementById('networkResult').innerHTML =
                        '<div class="result-box result-error">‚ùå ' + e.message + '</div>';
                });
        }

        // Clipboard paste
        async function pasteFromClipboard() {
            log('Intentando leer clipboard...', 'info');

            try {
                // Try clipboard API
                if (navigator.clipboard && navigator.clipboard.read) {
                    const items = await navigator.clipboard.read();
                    log('Items en clipboard: ' + items.length, 'info');

                    for (const item of items) {
                        log('Tipos: ' + item.types.join(', '), 'info');
                        for (const type of item.types) {
                            const blob = await item.getType(type);
                            log(`${type}: ${blob.size} bytes`, 'success');
                            if (blob.size > 1000) {
                                processBlob(blob, 'clipboard-file');
                            }
                        }
                    }
                } else {
                    log('Clipboard.read() no disponible', 'warning');
                }
            } catch (e) {
                log('Error clipboard: ' + e.message, 'error');
            }
        }

        // Handle file input
        function handleFile(input, source) {
            const file = input.files[0];
            if (file) {
                log(`[${source}] ${file.name}, ${file.size} bytes, tipo: ${file.type || 'sin tipo'}`, 'success');
                processFile(file);
            }
            input.value = '';
        }

        // Process file
        function processFile(file) {
            log('Procesando archivo...', 'info');

            const reader = new FileReader();
            reader.onload = () => {
                const arr = new Uint8Array(reader.result.slice(0, 16));
                const header = String.fromCharCode.apply(null, arr);

                if (header.includes('SQLite')) {
                    log('‚úÖ ¬°Es una base de datos SQLite v√°lida!', 'success');
                } else {
                    log('Header: ' + header, 'warning');
                    log('No parece ser SQLite, pero podr√≠a funcionar', 'warning');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processBlob(blob, name) {
            const file = new File([blob], name);
            processFile(file);
        }

        // Export functions
        function getFullLog() {
            return logEntries.map(e => `[${e.ts}] [${e.type}] ${e.msg}`).join('\n');
        }

        function saveToGitHub() {
            const body = encodeURIComponent(`## Debug v2 Log\n\n\`\`\`\n${getFullLog()}\n\`\`\``);
            const title = encodeURIComponent('[Debug v2] ' + new Date().toISOString());
            window.open(`https://github.com/miguelpicado/byd-stats/issues/new?title=${title}&body=${body}&labels=debug`, '_blank');
        }

        function shareLog() {
            if (navigator.share) {
                navigator.share({ title: 'Debug Log', text: getFullLog() });
            } else {
                log('Share API no disponible', 'error');
            }
        }

        function copyLog() {
            navigator.clipboard.writeText(getFullLog())
                .then(() => log('Log copiado', 'success'))
                .catch(e => log('Error: ' + e.message, 'error'));
        }

        // Init
        log('Debug v2 iniciado', 'info');
        log('UA: ' + navigator.userAgent, 'info');
        checkURLParams();
        checkShareTarget();
    </script>
</body>

</html>