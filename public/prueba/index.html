<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>BYD Stats Debug</title>
    <link rel="manifest" href="/prueba/manifest.json">
    <meta name="theme-color" content="#ea0029">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        html,
        body {
            height: 100%;
            overflow-x: hidden
        }

        body {
            font-family: system-ui, sans-serif;
            background: #0f172a;
            color: #fff;
            padding: 8px;
            padding-top: env(safe-area-inset-top, 8px);
            padding-bottom: env(safe-area-inset-bottom, 8px);
            font-size: 12px;
            min-height: 100vh;
        }

        h1 {
            color: #ea0029;
            text-align: center;
            font-size: 1.1rem;
            margin: 8px 0
        }

        h2 {
            font-size: 0.85rem;
            color: #94a3b8;
            margin: 4px 0
        }

        .c {
            background: #1e293b;
            border-radius: 8px;
            padding: 10px;
            margin: 6px 0;
            border: 1px solid #334155
        }

        .important {
            border-color: #ea0029;
            background: #1e1e2e
        }

        .pwa-banner {
            background: linear-gradient(135deg, #ea0029, #b91c1c);
            border: none;
            position: relative;
            overflow: hidden;
        }

        .pwa-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .btn {
            width: 100%;
            padding: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 4px 0;
            color: #fff
        }

        .r {
            background: #ea0029
        }

        .g {
            background: #059669
        }

        .y {
            background: #d97706
        }

        .b {
            background: #0284c7
        }

        .gr {
            background: #475569
        }

        .exit-btn {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: auto;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            font-size: 1rem;
        }

        .sm {
            padding: 8px 12px;
            width: auto;
            font-size: 0.75rem
        }

        input[type=file] {
            display: none
        }

        .log {
            background: #0f172a;
            border-radius: 4px;
            padding: 8px;
            font-family: monospace;
            font-size: 10px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all
        }

        .log-i {
            color: #60a5fa
        }

        .log-s {
            color: #4ade80
        }

        .log-e {
            color: #f87171
        }

        .log-w {
            color: #fbbf24
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px
        }

        .result {
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            font-size: 1rem;
            text-align: center
        }

        .result.ok {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.1)
        }

        .result.no {
            border-color: #f87171;
            background: rgba(248, 113, 113, 0.1)
        }

        .info {
            font-size: 0.75rem;
            color: #94a3b8;
            margin: 4px 0;
            line-height: 1.4
        }

        .step {
            background: #334155;
            padding: 6px 10px;
            border-radius: 4px;
            margin: 3px 0;
            font-size: 0.75rem
        }

        .flex {
            display: flex;
            gap: 4px;
            flex-wrap: wrap
        }

        .tag {
            background: #334155;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            margin: 1px
        }

        .tag.ok {
            background: #059669
        }

        .tag.no {
            background: #dc2626
        }

        code {
            background: #334155;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem
        }

        .standalone-only {
            display: none
        }

        .browser-only {
            display: block
        }

        @media (display-mode: standalone),
        (display-mode: fullscreen) {
            .standalone-only {
                display: block
            }

            .browser-only {
                display: none
            }
        }

        .pwa-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .pwa-status.installed {
            background: #059669
        }

        .pwa-status.browser {
            background: #d97706
        }
    </style>
</head>

<body>
    <!-- Exit button for fullscreen PWA -->
    <button class="btn exit-btn standalone-only" onclick="exitApp()">‚úï Salir</button>

    <h1>üî¨ BYD Stats Debug</h1>
    <p style="text-align:center;color:#64748b;font-size:0.7rem">
        Ruta: /Local/energydata/EC_Database.db
        <span id="pwaStatus" class="pwa-status"></span>
    </p>

    <!-- RESULTADO -->
    <div id="mainResult" class="result" style="display:none"></div>

    <!-- PWA Installation Banner -->
    <div id="pwaInstall" class="c pwa-banner browser-only" style="display:none">
        <h2 style="color:#fff">üì≤ ¬°Instala la App!</h2>
        <p class="info" style="color:rgba(255,255,255,0.8)">Instala esta app para poder recibir archivos compartidos
            desde el explorador de archivos</p>
        <button class="btn" style="background:rgba(255,255,255,0.2);border:2px solid #fff" onclick="installPWA()">
            üì≤ Instalar BYD Stats Debug
        </button>
    </div>

    <!-- PWA Installed Success -->
    <div class="c standalone-only" style="background: linear-gradient(135deg, #059669, #047857); border:none">
        <h2 style="color:#fff">‚úÖ PWA Instalada</h2>
        <p class="info" style="color:rgba(255,255,255,0.9)">
            Ahora puedes compartir archivos desde el explorador de archivos del coche a esta app.
        </p>
        <div class="step" style="background:rgba(0,0,0,0.2);color:#fff">1. Abre el explorador de archivos</div>
        <div class="step" style="background:rgba(0,0,0,0.2);color:#fff">2. Navega a /Local/energydata/</div>
        <div class="step" style="background:rgba(0,0,0,0.2);color:#fff">3. Pulsa en EC_Database.db ‚Üí Compartir</div>
        <div class="step" style="background:rgba(0,0,0,0.2);color:#fff">4. Selecciona "BYD Stats Debug"</div>
    </div>

    <!-- PASO 0: Chrome Flags -->
    <div class="c important">
        <h2>‚öôÔ∏è PASO 0: Chrome Flags (hacer primero)</h2>
        <p class="info">Antes de probar los m√©todos, intenta activar estas flags:</p>
        <div class="step">1. Abre nueva pesta√±a ‚Üí escribe <code>chrome://flags</code></div>
        <div class="step">2. Busca <code>picker</code> o <code>media</code></div>
        <div class="step">3. Si existe <code>#media-picker-adoption</code> ‚Üí <b>Disabled</b></div>
        <div class="step">4. Si existe <code>#deprecated-external-picker</code> ‚Üí <b>Enabled</b></div>
        <div class="step">5. Pulsa <b>Relaunch</b> para reiniciar Chrome</div>
    </div>

    <!-- M√âTODO 1: Input File TRUCO -->
    <div class="c important">
        <h2>üéØ M√âTODO 1: Selector de Archivos</h2>
        <p class="info">Diferentes combinaciones de MIME types para intentar abrir un selector de archivos completo</p>
        <div class="grid">
            <button class="btn g" onclick="$('f0').click()">üéØ TRUCO 1</button>
            <button class="btn g" onclick="$('f1').click()">üéØ TRUCO 2</button>
            <button class="btn y" onclick="$('f2').click()">img+text</button>
            <button class="btn y" onclick="$('f3').click()">all mixed</button>
            <button class="btn gr" onclick="$('f4').click()">*/*</button>
            <button class="btn gr" onclick="$('f5').click()">sin accept</button>
        </div>
        <input type="file" id="f0" accept="image/*,text/plain,application/octet-stream"
            onchange="onFile(this,'TRUCO 1')">
        <input type="file" id="f1" accept="text/*,image/*,video/*,.db,.sqlite" onchange="onFile(this,'TRUCO 2')">
        <input type="file" id="f2" accept="image/*,text/*" onchange="onFile(this,'img+text')">
        <input type="file" id="f3" accept="image/*,text/plain,video/*,audio/*,.db,.sqlite,application/octet-stream,*/*"
            onchange="onFile(this,'all mixed')">
        <input type="file" id="f4" accept="*/*" onchange="onFile(this,'*/*')">
        <input type="file" id="f5" onchange="onFile(this,'sin accept')">
    </div>

    <!-- M√âTODO 2: Directorio -->
    <div class="c">
        <h2>üìÇ M√âTODO 2: Seleccionar Carpeta</h2>
        <p class="info">Intenta seleccionar la carpeta energydata completa</p>
        <button class="btn y" onclick="$('fdir').click()">üìÇ Seleccionar carpeta</button>
        <input type="file" id="fdir" webkitdirectory onchange="onDir(this)">
    </div>

    <!-- M√âTODO 3: Navegaci√≥n -->
    <div class="c">
        <h2>üß≠ M√âTODO 3: Navegar a file://</h2>
        <p class="info">Navegar directamente a la ruta del archivo</p>
        <button class="btn y" onclick="tryNavigate('file:///Local/energydata/')">üß≠ Ir a /Local/energydata/</button>
        <button class="btn gr" onclick="tryNavigate('file:///Local/')">üìÇ Ir a /Local/</button>
    </div>

    <!-- APIs disponibles -->
    <div class="c">
        <h2>üìä APIs Detectadas</h2>
        <div id="apis" class="flex"></div>
    </div>

    <!-- Export -->
    <div class="c">
        <h2>üì§ Exportar Log</h2>
        <div class="flex">
            <button class="btn sm r" onclick="toGH()">üêô GitHub</button>
            <button class="btn sm g" onclick="share()">üì§ Share</button>
            <button class="btn sm y" onclick="copy()">üìã Copy</button>
        </div>
    </div>

    <!-- Log -->
    <div class="c">
        <h2>üìã Log</h2>
        <div id="log" class="log"></div>
    </div>

    <div style="height:80px"></div> <!-- Spacer for exit button -->

    <script>
        const $ = id => document.getElementById(id);
        const logs = [];
        let deferredPrompt = null;

        function log(m, t = 'i') {
            const ts = new Date().toLocaleTimeString();
            logs.push({ ts, t, m });
            $('log').innerHTML += `<span class="log-${t}">[${ts}][${t}] ${m}</span>\n`;
            $('log').scrollTop = $('log').scrollHeight;
        }

        function showResult(msg, ok) {
            const r = $('mainResult');
            r.style.display = 'block';
            r.textContent = msg;
            r.className = 'result ' + (ok ? 'ok' : 'no');
        }

        // PWA Status
        function updatePWAStatus() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                window.matchMedia('(display-mode: fullscreen)').matches ||
                window.navigator.standalone;
            const status = $('pwaStatus');
            if (isStandalone) {
                status.textContent = '‚úì PWA';
                status.className = 'pwa-status installed';
                log('Ejecutando como PWA instalada', 's');
            } else {
                status.textContent = '‚ö† Navegador';
                status.className = 'pwa-status browser';
                log('Ejecutando en navegador (no PWA)', 'w');
            }
        }

        // PWA Install
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault();
            deferredPrompt = e;
            $('pwaInstall').style.display = 'block';
            log('PWA instalable detectada', 's');
        });

        async function installPWA() {
            if (!deferredPrompt) {
                log('No hay prompt de instalaci√≥n disponible', 'w');
                // Fallback: show manual instructions
                alert('Para instalar:\n1. Abre el men√∫ de Chrome (‚ãÆ)\n2. Selecciona "A√±adir a pantalla de inicio"\n3. Confirma la instalaci√≥n');
                return;
            }
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            log('Instalaci√≥n: ' + outcome, outcome === 'accepted' ? 's' : 'w');
            deferredPrompt = null;
            $('pwaInstall').style.display = 'none';
        }

        // Exit App
        function exitApp() {
            if (confirm('¬øCerrar la aplicaci√≥n?')) {
                log('Cerrando app...', 'i');
                window.close();
                // Fallback if window.close() doesn't work
                setTimeout(() => {
                    window.location.href = 'about:blank';
                }, 100);
            }
        }

        // Process blob
        function processBlob(blob, name) {
            log(`Procesando: ${name}, ${blob.size} bytes`, 's');

            if (blob.size < 1000) {
                log('Archivo muy peque√±o', 'w');
            }

            const reader = new FileReader();
            reader.onload = e => {
                const arr = new Uint8Array(e.target.result);
                const header = String.fromCharCode.apply(null, arr.slice(0, 6));
                if (header === 'SQLite') {
                    log('‚úÖ ¬°Es un archivo SQLite v√°lido!', 's');
                    showResult('‚úÖ ¬°√âXITO! SQLite: ' + name + ' (' + blob.size + ' bytes)', true);
                    // Store in IndexedDB
                    storeFile(blob, name);
                } else {
                    log('Header: ' + header, 'w');
                    showResult('Archivo recibido: ' + name + ' (' + blob.size + ' bytes)', true);
                }
            };
            reader.readAsArrayBuffer(blob.slice(0, 16));
        }

        // Store file in IndexedDB
        async function storeFile(blob, name) {
            try {
                const db = await openDB();
                const tx = db.transaction('files', 'readwrite');
                const store = tx.objectStore('files');
                const buffer = await blob.arrayBuffer();
                await store.put({ id: 'database', name, data: buffer, timestamp: Date.now() });
                log('Archivo guardado en IndexedDB', 's');
            } catch (e) {
                log('Error guardando: ' + e.message, 'e');
            }
        }

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('byd-debug', 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = e => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('files')) {
                        db.createObjectStore('files', { keyPath: 'id' });
                    }
                };
            });
        }

        // Check for shared file (from Share Target)
        async function checkSharedFile() {
            const params = new URLSearchParams(location.search);
            if (params.has('shared') || params.has('filename')) {
                log('¬°Datos recibidos via Share Target!', 's');
                log('Params: ' + location.search, 'i');

                // Try to get file from IndexedDB (stored by Service Worker)
                try {
                    const db = await openDB();
                    const tx = db.transaction('files', 'readonly');
                    const store = tx.objectStore('files');
                    const request = store.get('shared-file');
                    request.onsuccess = () => {
                        const file = request.result;
                        if (file) {
                            log('Archivo encontrado en IndexedDB: ' + file.name, 's');
                            showResult('‚úÖ Archivo recibido: ' + file.name + ' (' + file.size + 'b)', true);
                        }
                    };
                } catch (e) {
                    log('Error buscando archivo: ' + e.message, 'e');
                }
            }
        }

        // 1. Input File
        function onFile(input, method) {
            const f = input.files[0];
            if (!f) { log('No se seleccion√≥ archivo con ' + method, 'w'); return }
            log(`[${method}] Archivo: ${f.name}, Tipo: ${f.type}, Tama√±o: ${f.size}`, 's');
            processBlob(f, f.name);
        }

        // 2. Directory
        function onDir(input) {
            const files = input.files;
            log(`Carpeta: ${files.length} archivos`, 'i');
            for (const f of files) {
                log(`  - ${f.webkitRelativePath}: ${f.size}b`, 'i');
                if (f.name.toLowerCase().includes('database') || f.name.endsWith('.db')) {
                    log('¬°Encontrado posible DB!', 's');
                    processBlob(f, f.name);
                }
            }
        }

        // 3. Navigate
        function tryNavigate(url) {
            if (!confirm('Saldr√°s de esta p√°gina. ¬øContinuar?')) return;
            log('Navegando a: ' + url, 'i');
            window.location.href = url;
        }

        // Detect APIs
        function detectAPIs() {
            const apis = {
                'showDirectoryPicker': 'showDirectoryPicker' in window,
                'showOpenFilePicker': 'showOpenFilePicker' in window,
                'webkitdirectory': 'webkitdirectory' in document.createElement('input'),
                'FileReader': 'FileReader' in window,
                'IndexedDB': 'indexedDB' in window,
                'Share': 'share' in navigator,
                'ServiceWorker': 'serviceWorker' in navigator,
                'launchQueue': 'launchQueue' in window
            };
            $('apis').innerHTML = Object.entries(apis).map(([n, ok]) => {
                log(`API ${n}: ${ok ? 'S√ç' : 'NO'}`, ok ? 's' : 'w');
                return `<span class="tag ${ok ? 'ok' : 'no'}">${ok ? '‚úÖ' : '‚ùå'} ${n}</span>`;
            }).join('');
        }

        // Check for LaunchQueue (file_handlers)
        if ('launchQueue' in window) {
            window.launchQueue.setConsumer(launchParams => {
                log('LaunchQueue activado', 's');
                if (launchParams.files && launchParams.files.length > 0) {
                    log('Archivos recibidos via file_handlers: ' + launchParams.files.length, 's');
                    launchParams.files.forEach(async fileHandle => {
                        const file = await fileHandle.getFile();
                        log('Archivo: ' + file.name, 's');
                        processBlob(file, file.name);
                    });
                }
            });
        }

        // Export
        function getLog() { return logs.map(l => `[${l.ts}][${l.t}] ${l.m}`).join('\n') }
        function toGH() {
            const b = encodeURIComponent('```\n' + getLog() + '\n```');
            const t = encodeURIComponent('[Debug v4] ' + new Date().toISOString());
            window.open(`https://github.com/miguelpicado/byd-stats/issues/new?title=${t}&body=${b}&labels=debug`, '_blank');
        }
        function share() { navigator.share?.({ title: 'Debug', text: getLog() }) || log('Share no disponible', 'e') }
        function copy() { navigator.clipboard.writeText(getLog()).then(() => log('Copiado', 's')).catch(e => log(e.message, 'e')) }

        // Register SW
        async function registerSW() {
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('/prueba/sw.js', { scope: '/prueba/' });
                    log('Service Worker registrado', 's');
                } catch (e) { log('SW error: ' + e.message, 'e') }
            }
        }

        // Init
        log('Debug v4 iniciado', 'i');
        log('UA: ' + navigator.userAgent, 'i');
        log('Ruta objetivo: /Local/energydata/EC_Database.db', 'i');
        updatePWAStatus();
        detectAPIs();
        registerSW();
        checkSharedFile();
    </script>
</body>

</html>